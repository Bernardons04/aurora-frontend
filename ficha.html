<!DOCTYPE html>
<html lang="pt-BR">

<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title> Aurora RPG</title>
<link rel="icon" type="image/png" href="assets/favicon-aurora.png">
<!-- Bootstrap 5.2.3 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/dist/umd/supabase.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
<!-- Fonte IM Fell English SC -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=IM+Fell+English+SC&display=swap" rel="stylesheet">
<link rel="stylesheet" href="style.css" />

<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

</head>

<body>
<div id="app" class="container py-3" v-cloak>

    <!-- NAV TABS -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <ul class="nav nav-tabs">
            <li class="nav-item">
                <button class="nav-link" :class="{active: activeTab==='ficha'}"
                    @click="setTab('ficha')">Ficha</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" :class="{active: activeTab==='poderes'}"
                    @click="setTab('poderes')">Dom</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" :class="{active: activeTab==='livro'}"
                    @click="setTab('livro')">Livro</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" :class="{active: activeTab==='notas'}"
                    @click="setTab('notas')">Notas</button>
            </li>
        </ul>

        <!-- BARRA SUPERIOR COM AVATAR E DROPDOWN -->
        <div class="d-flex align-items-center justify-content-between">
            <!-- Dropdown do usuário -->
            <div class="dropdown" v-if="user">
                <button class="btn btn-outline-secondary rounded-circle p-0 position-relative"
                    data-bs-toggle="dropdown" aria-expanded="false" id="userDropdown" style="width: 48px; height: 48px;">
                    <img :src="user.user_metadata.avatar_url || 'assets/default-avatar.png'" class="rounded-circle"
                        width="48" height="48" alt="Avatar">
                    <span class="position-absolute bottom-0 end-0 bg-success border border-light rounded-circle"
                        style="width: 14px; height: 14px;"></span>
                </button>

                <div class="dropdown-menu dropdown-menu-end mt-2 p-0" aria-labelledby="userDropdown" data-bs-display="static">
                    <li class="dropdown-item-text px-3 py-2">
                        <div class="d-flex align-items-center gap-3">
                            <img :src="user.user_metadata.avatar_url || 'assets/default-avatar.png'"
                                class="rounded-circle" width="40" height="40">
                            <div>
                                <strong>{{ user.user_metadata.full_name || user.email }}</strong><br>
                                <small class="text-muted">{{ user.email }}</small>
                            </div>
                        </div>
                    </li>
                    <li>
                        <hr class="dropdown-divider my-0">
                    </li>
                    <li>
                        <button @click="toggleTheme" class="dropdown-item d-flex align-items-center gap-2">
                            <i class="bi" :class="theme === 'dark' ? 'bi-sun' : 'bi-moon-stars'"></i>
                            {{ theme === 'dark' ? 'Tema Claro' : 'Tema Escuro' }}
                        </button>
                    </li>
                    <li>
                        <button @click="logout" class="dropdown-item text-danger d-flex align-items-center gap-2">
                            <i class="bi bi-box-arrow-right"></i>
                            Sair
                        </button>
                    </li>
                </div>
            </div>
        </div>
    </div>



    <!-- CONTEÚDO FICHA -->
    <div v-if="activeTab==='ficha'">

        <!-- AÇÕES ACIMA DO HEADER -->
        <div class="d-flex justify-content-end align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex">
                <button class="btn btn-secondary ms-2" @click="exportJson">Exportar</button>
                <label class="btn btn-secondary ms-2 mb-0">
                    Importar
                    <input type="file" ref="importFile" @change="handleImport" accept="application/json"
                        style="display:none" />
                </label>

                <button :class="['btn ms-2', editMode? 'btn-cancel':'btn-edit']" @click="toggleEdit"
                    v-if="!editMode">Editar</button>
                <span v-else>
                    <button class="btn btn-cancel mx-2" @click="cancelEdit">Cancelar</button>
                    <button class="btn btn-save" @click="saveAndExport">Salvar</button>
                </span>
            </div>
        </div>

        <hr>

        <!-- HEADER -->
        <div class="container-header container-fluid py-3 d-flex justify-content-between align-items-end gap-4">

            <!-- ESQUERDA: CAMPOS PERSONAGEM / DOM / ORIGEM -->
            <div class="header-left w-100">

                <div class="aurora-header-block mb-4 w-100">
                    <label class="aurora-header-label">Personagem</label>

                    <!-- Texto (quando não está editando) -->
                    <div v-if="!editMode" class="aurora-display-text">
                        {{ personagem.nome || '—' }}
                    </div>

                    <!-- Input (quando editando) -->
                    <input v-else type="text" class="form-control" v-model="personagem.nome">
                </div>

                <div class="d-flex gap-3">
                    <div class="aurora-header-block w-100">
                        <label class="aurora-header-label">Dom</label>

                        <div v-if="!editMode" class="aurora-display-text">
                            {{ personagem.dom || '—' }}
                        </div>

                        <select v-else class="form-select" v-model="personagem.dom">
                            <option value="">Selecione um dom...</option>
                            <option v-for="dom in dons" :key="dom" :value="dom">{{ dom }}</option>
                        </select>
                    </div>

                    <!-- Nível (novo) -->
                    <div class="aurora-header-block" style="min-width:120px; max-width:160px;">
                        <label class="aurora-header-label">Nível</label>
                        <div v-if="!editMode" class="aurora-display-text">
                            {{ personagem.nivel || 1 }}
                        </div>
                        <input v-else type="number" min="1" class="form-control" v-model.number="personagem.nivel">
                    </div>

                    <div class="aurora-header-block">
                        <label class="aurora-header-label">Origem</label>

                        <div v-if="!editMode" class="aurora-display-text">
                            {{ personagem.origem || '—' }}
                        </div>

                        <!-- Select de Origens (aplica bônus automaticamente) -->
                        <select v-else class="form-select" v-model="personagem.origem" @change="applyOriginBonuses">
                            <option value="">Selecione uma origem...</option>
                            <option v-for="o in origens" :key="o.nome" :value="o.nome">
                                {{ o.nome }}
                            </option>
                        </select>
                    </div>

                </div>

            </div>

            <!-- DIREITA: LOGO -->
            <div class="header-right text-end">
                <img src="assets/aurora-logo.png" class="aurora-logo">
            </div>

        </div>

        <!-- LAYOUT EM DUAS COLUNAS -->
        <div class="row">
            <!-- COLUNA 1 -->
            <div class="col-lg-6">

                <!-- FOTO -->
                <div class="text-center mb-3">
                    <div class="portrait-frame mx-auto mb-2">
                        <img src="assets/avatar-frame.png" class="frame-overlay" />

                        <img :src="personagem.foto || placeholder" class="foto-personagem" />

                        <input type="file" :disabled="!editMode" @change="carregarFoto" class="file-input"
                            accept="image/*" />
                    </div>
                </div>

                <!-- ATRIBUTOS -->
                <h5 class="section-title">Atributos</h5>
                <div class="row g-2 mb-3 attrs-wrap pericias-block p-3 mb-3 mt-2">
                    <span class="text-center w-100 mt-0 mb-2">
                        Total: {{ totalAtributos }}
                    </span>
                    <div v-for="(val,key) in personagem.atributos" :key="key" class="col-4"
                        :class="{ 'mt-0': key === 'car' || key === 'des' || key === 'for' }">
                        <div class="input-group attr-input">
                            <span class="input-group-text attr-label">{{ key.toUpperCase() }}</span>
                            <input :disabled="!editMode" type="number" v-model.number="personagem.atributos[key]"
                                class="form-control" />
                        </div>
                    </div>
                </div>

                <!-- PV e PD -->
                <h5 class="section-title">PV & PD</h5>
                <div class="row pericias-block p-3 mb-3 mt-2" style="margin-left: -4px; margin-right: -4px;">
                    <div class="col-6 ps-0">
                        <label class="form-label small">Pontos de Vida</label>
                        <div class="input-group mb-1">
                            <span class="input-group-text attr-label">Max</span>
                            <input :disabled="!editMode" type="number" v-model.number="personagem.pv.max"
                                class="form-control" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-text attr-label">Atual</span>
                            <input :disabled="!editMode" type="number" v-model.number="personagem.pv.atual"
                                class="form-control" />
                        </div>
                    </div>
                    <div class="col-6 pe-0">
                        <label class="form-label small">Pontos de Dom</label>
                        <div class="input-group mb-1">
                            <span class="input-group-text attr-label">Max</span>
                            <input :disabled="!editMode" type="number" v-model.number="personagem.pd.max"
                                class="form-control" />
                        </div>
                        <div class="input-group">
                            <span class="input-group-text attr-label">Atual</span>
                            <input :disabled="!editMode" type="number" v-model.number="personagem.pd.atual"
                                class="form-control" />
                        </div>
                    </div>
                </div>

                <!-- DEFESA -->
                <h5 class="section-title">Defesa</h5>
                <div class="defesa-block pericias-block p-3 mb-3 mt-2">
                    <div class="row g-3 align-items-stretch">
                        <!-- TOTAL (centro) -->
                        <div class="col-12 col-md-3 d-flex justify-content-center">
                            <div
                                class="defesa-total-display w-100 d-flex flex-column justify-content-center align-self-center">
                                <div>TOTAL</div>
                                <div class="defesa-total-value">{{ totalDefesa }}</div>
                            </div>
                        </div>

                        <!-- GRID 2x2 (direita) -->
                        <div class="col-12 col-md-6">
                            <div class="row g-2">
                                <div class="col-6">
                                    <label class="form-label small mb-1">Destreza (bônus)</label>
                                    <div class="input-group">
                                        <span class="input-group-text attr-label">DES</span>
                                        <input type="number" class="form-control text-center" :value="bonusDestreza"
                                            disabled>
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-1">Armadura</label>
                                    <div class="input-group">
                                        <span class="input-group-text attr-label">ARM</span>
                                        <input :disabled="!editMode" type="number"
                                            v-model.number="personagem.defesa.armadura"
                                            class="form-control text-center">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-1">Escudo</label>
                                    <div class="input-group">
                                        <span class="input-group-text attr-label">ESC</span>
                                        <input :disabled="!editMode" type="number"
                                            v-model.number="personagem.defesa.escudo"
                                            class="form-control text-center">
                                    </div>
                                </div>
                                <div class="col-6">
                                    <label class="form-label small mb-1">Outros</label>
                                    <div class="input-group">
                                        <span class="input-group-text attr-label">OUT</span>
                                        <input :disabled="!editMode" type="number"
                                            v-model.number="personagem.defesa.outros"
                                            class="form-control text-center">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3 defesa-breakdown small text-muted">
                        10 (Base) + {{ bonusDestreza }} (Destreza) + {{ personagem.defesa.armadura || 0 }}
                        (Armadura) +
                        {{ personagem.defesa.escudo || 0 }} (Escudo) + {{ personagem.defesa.outros || 0 }} (Outros)
                    </div>
                </div>
                <!-- ATAQUES -->
                <h5 class="section-title">Ataques / Ações</h5>
                <div class="pericias-block p-3 mb-3">
                    <div class="input-group">
                        <input :disabled="!editMode" v-model="novoAtaque.nome" class="form-control"
                            placeholder="Nome" />
                        <input :disabled="!editMode" v-model="novoAtaque.teste" class="form-control"
                            placeholder="Teste" />
                        <input :disabled="!editMode" v-model="novoAtaque.dano" class="form-control"
                            placeholder="Dano" />
                        <input :disabled="!editMode" v-model="novoAtaque.tipo" class="form-control"
                            placeholder="Tipo" />
                        <input :disabled="!editMode" v-model="novoAtaque.critico" class="form-control"
                            placeholder="Crítico" />
                        <input :disabled="!editMode" v-model="novoAtaque.alcance" class="form-control"
                            placeholder="Alcance" />
                        <button :disabled="!editMode" class="btn btn-gold" @click="adicionarAtaque">+</button>
                    </div>

                    <ul class="list-group" :class="{'mt-2': personagem.ataques.length}">
                        <li v-for="(atk, idx) in personagem.ataques" :key="idx"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <div>
                                <strong>{{ atk.nome }}</strong>
                                <div class="small text-muted">Teste: {{ atk.teste }} — Dano: {{ atk.dano }} — Tipo:
                                    {{ atk.tipo }} —
                                    Crítico: {{ atk.critico }} — Alc: {{ atk.alcance }}</div>
                            </div>
                            <button :disabled="!editMode" class="btn btn-sm btn-danger"
                                @click="removerAtaque(idx)">Remover</button>
                        </li>
                    </ul>
                </div>

                <!-- HABILIDADES / DONS -->

                <h5 class="section-title">Habilidades & Dons</h5>
                <div class="pericias-block p-3 mb-3">
                    <div class="input-group">
                        <input :disabled="!editMode" v-model="novaHab" class="form-control"
                            placeholder="Nova habilidade" />
                        <button :disabled="!editMode" class="btn btn-gold" @click="adicionarHab">+</button>
                    </div>
                    <ul class="list-group" :class="{'mt-2': personagem.habilidades.length}">
                        <li v-for="(h, i) in personagem.habilidades" :key="i"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ h }}</span>
                            <button :disabled="!editMode" class="btn btn-sm btn-danger"
                                @click="removerHab(i)">Remover</button>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- COLUNA 2 -->
            <div class="col-lg-6 mb-4">

                <h5 class="section-title">Perícias</h5>

                <div class="pericias-block p-3 mb-3">
                    <div class="d-flex fw-bold mb-2 small">
                        <div style="width:36%">Perícia</div>
                        <div style="width:14%">Total</div>
                        <div style="width:12%">1/2 Nível</div>
                        <div style="width:12%">Atributo</div>
                        <div style="width:13%">Treino</div>
                        <div style="width:13%">Outros</div>
                    </div>

                    <div v-for="(p, idx) in pericias" :key="p.nome"
                        class="d-flex align-items-center pericia-row mb-2 gap-1">
                        <div style="width:36%">{{ p.nome }} <small class="text-muted">({{ p.atrib }})</small></div>
                        <div style="width:14%" class="text-center">
                            <input :disabled="true" type="number" class="form-control form-control-sm text-center"
                                :value="totalPericia(p)" readonly />
                        </div>
                        <!-- 1/2 Nível agora calculado automaticamente -->
                        <div style="width:12%">
                            <input disabled type="number" :value="halfLevelValue"
                                class="form-control form-control-sm text-center" />
                        </div>
                        <!-- BONUS DO ATRIBUTO (auto) -->
                        <div style="width:12%">
                            <input disabled type="number" :value="attrBonusFromSigla(p.atrib)"
                                class="form-control form-control-sm text-center" />
                        </div>
                        <div style="width:13%"><input :disabled="!editMode" type="number" v-model.number="p.treino"
                                class="form-control form-control-sm" /></div>
                        <div style="width:13%"><input :disabled="!editMode" type="number" v-model.number="p.outros"
                                class="form-control form-control-sm" /></div>
                    </div>
                </div>

                <!-- EQUIPAMENTO -->
                <h5 class="section-title">Equipamentos</h5>
                <div class="pericias-block p-3 mb-3">
                    <div class="input-group">
                        <input :disabled="!editMode" v-model="novoItem" class="form-control"
                            placeholder="Novo item" />
                        <button :disabled="!editMode" class="btn btn-gold" @click="addItem">+</button>
                    </div>
                    <ul class="list-group mb-3" :class="{'mt-2': personagem.equipamentos.length}">
                        <li v-for="(item, i) in personagem.equipamentos" :key="i"
                            class="list-group-item d-flex justify-content-between align-items-center">
                            <span>{{ item }}</span>
                            <button :disabled="!editMode" class="btn btn-sm btn-danger"
                                @click="delItem(i)">Remover</button>
                        </li>
                    </ul>

                    <div class="row g-2">
                        <div class="col-6">
                            <div class="input-group">
                                <span class="input-group-text attr-label">M.O</span>
                                <input :disabled="!editMode" type="number" v-model.number="personagem.mo"
                                    class="form-control" />
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="input-group">
                                <span class="input-group-text attr-label">Peso (kg)</span>
                                <input :disabled="!editMode" type="number" v-model.number="personagem.peso"
                                    class="form-control" />
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
    <div v-if="activeTab==='poderes'" class="poderes-wrapper fade-in">

        <div v-if="!personagem.dom" class="text-center py-5">
            <h4 class="text-muted">Selecione um Dom na aba "Ficha" para ver seus poderes.</h4>
        </div>

        <div v-else-if="!currentDomData" class="text-center py-5">
            <h4 class="text-muted">Os dados para o dom "{{personagem.dom}}" não foram encontrados.</h4>
        </div>
        <div v-else>
            <!-- Header da Aba Poderes -->
            <div class="row align-items-center mb-4">
                <!-- Spacer Esquerda (apenas desktop) para balancear o layout e garantir o centro exato -->
                <div class="col-md-3 d-none d-md-block"></div>

                <!-- Título Centralizado -->
                <div class="col-12 col-md-6 text-center">
                    <h2 class="section-title mb-0">{{ personagem.dom }}</h2>
                    <div class="small text-muted mt-1">Atributo Chave: <strong>{{ currentDomData.atributo
                            }}</strong></div>
                </div>

                <!-- Pontos à Direita (Centralizado no mobile, Direita no desktop) -->
                <div class="col-12 col-md-3 d-flex justify-content-center justify-content-md-end mt-3 mt-md-0">
                    <div class="points-display">
                        <div class="points-label">Pontos de Dom</div>
                        <div class="points-value" :class="{'text-danger': pontosDisponiveis < 0}">
                            {{ pontosGastos }} / {{ personagem.nivel }}
                        </div>
                        <div class="small text-muted" v-if="pontosDisponiveis > 0">
                            {{ pontosDisponiveis }} disponível(is)
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Loop pelas 3 Linhas (Ataque, Defesa, Efeitos) -->
                <div class="col-lg-4 col-md-6" v-for="(linha, tipo) in currentDomData.linhas" :key="tipo">
                    <div class="power-column">
                        <h5 class="power-col-title">{{ tipo }}</h5>
                        <div class="power-col-subtitle">{{ linha.titulo }}</div>

                        <div class="power-tree">
                            <!-- Loop pelos Níveis (1, 2, 3) -->
                            <div v-for="poder in linha.poderes" :key="poder.nome" class="power-card-wrapper">

                                <!-- Conector Visual -->
                                <div v-if="poder.nivel > 1" class="power-connector"
                                    :class="{ 'active': hasPower(poder.nome) }"></div>

                                <div class="power-card" :class="{ 
                     'learned': hasPower(poder.nome), 
                     'available': canBuy(poder, tipo),
                     'locked': !hasPower(poder.nome) && !canBuy(poder, tipo)
                   }" @click="togglePower(poder, tipo)">

                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <span class="badge bg-dark-gold">Nível {{ poder.nivel }}</span>
                                        <i v-if="hasPower(poder.nome)"
                                            class="bi bi-check-circle-fill text-success"></i>
                                        <i v-else-if="canBuy(poder, tipo)" class="bi bi-unlock text-muted"></i>
                                        <i v-else class="bi bi-lock-fill text-muted opacity-50"></i>
                                    </div>

                                    <h6 class="power-name">{{ poder.nome }}</h6>

                                    <div class="power-meta">
                                        <span><i class="bi bi-lightning-charge"></i> {{ poder.custo }}</span>
                                        <span><i class="bi bi-hourglass-split"></i> {{ poder.acao }}</span>
                                    </div>

                                    <p class="power-desc">{{ poder.desc }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div v-if="activeTab==='livro'" class="livro-wrapper">
        <div class="mb-2 d-flex justify-content-between align-items-center">
            <h5 class="section-title mb-0">Livro do Sistema</h5>
            <a href="assets/livro.pdf" target="_blank" class="btn btn-gold btn-sm"><i
                    class="bi bi-box-arrow-up-right"></i></a>
        </div>
        <div class="pdf-frame">
            <object data="assets/livro.pdf#toolbar=0&navpanes=0" type="application/pdf" width="100%" height="100%">
                <p>Seu navegador não abriu o PDF. <a href="assets/livro.pdf" target="_blank">Clique para baixar</a>.
                </p>
            </object>
        </div>
    </div>
    <div v-if="activeTab==='notas'" class="notas-wrapper">
        <h5 class="section-title mb-3">Notas</h5>
        <textarea v-model="notas" ref="notesArea" @input="autoGrowNotes" class="form-control notes-textarea"
            placeholder="Escreva aqui seus diários, ganchos, NPCs, mapas mentais e tudo mais..."></textarea>
        <div class="text-end mt-2 small text-muted">As notas são salvas ao clicar em Salvar e incluídas no
            Exportar/Importar JSON.</div>
    </div>
</div>

<script src="config.js"></script>
<script src="script.js"></script>
</body>

</html>
